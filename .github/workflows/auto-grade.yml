name: è‡ªåŠ¨æ‰¹æ”¹Rä½œä¸š

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'assignments/**/*.R'

jobs:
  auto-grade:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
    
    - name: è®¾ç½®Rç¯å¢ƒ
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.3.0'
    
    - name: å®‰è£…RåŒ…
      run: |
        install.packages(c("testthat", "ggplot2", "moments", "lintr"))
      shell: Rscript {0}
    
    - name: æ£€æµ‹ä¿®æ”¹çš„ä½œä¸š
      id: detect-assignment
      run: |
        CHANGED_FILES=$(git diff --name-only origin/main...HEAD | grep -E "assignments/.*/assignment\.R$" | head -1)
        if [ -n "$CHANGED_FILES" ]; then
          ASSIGNMENT_DIR=$(dirname "$CHANGED_FILES")
          echo "assignment_dir=$ASSIGNMENT_DIR" >> $GITHUB_OUTPUT
          echo "å‘ç°ä¿®æ”¹çš„ä½œä¸š: $ASSIGNMENT_DIR"
        else
          echo "æ²¡æœ‰å‘ç°ä½œä¸šæ–‡ä»¶ä¿®æ”¹"
          exit 1
        fi
    
    - name: è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥
      run: |
        library(lintr)
        assignment_file <- "${{ steps.detect-assignment.outputs.assignment_dir }}/assignment.R"
        if (file.exists(assignment_file)) {
          lint_results <- lint(assignment_file)
          if (length(lint_results) > 0) {
            cat("ä»£ç è´¨é‡é—®é¢˜:\n")
            print(lint_results)
          } else {
            cat("ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡!\n")
          }
        }
      shell: Rscript {0}
      continue-on-error: true
    
    - name: è¿è¡Œè‡ªåŠ¨æµ‹è¯•
      id: run-tests
      run: |
        cd "${{ steps.detect-assignment.outputs.assignment_dir }}"
        Rscript tests.R > test_results.txt 2>&1
        cat test_results.txt
        
        # æå–åˆ†æ•°
        SCORE=$(grep "æ€»åˆ†:" test_results.txt | sed 's/.*æ€»åˆ†: \([0-9]*\).*/\1/')
        echo "score=$SCORE" >> $GITHUB_OUTPUT
      continue-on-error: true
    
    - name: ç”Ÿæˆè¯„åˆ†æŠ¥å‘Š
      run: |
        SCORE="${{ steps.run-tests.outputs.score }}"
        PR_NUMBER="${{ github.event.pull_request.number }}"
        STUDENT_NAME="${{ github.event.pull_request.user.login }}"
        
        echo "# ğŸ“Š ä½œä¸šè¯„åˆ†æŠ¥å‘Š" > grade_report.md
        echo "" >> grade_report.md
        echo "**å­¦ç”Ÿ**: @$STUDENT_NAME" >> grade_report.md
        echo "**PRç¼–å·**: #$PR_NUMBER" >> grade_report.md
        echo "**ä½œä¸š**: ${{ steps.detect-assignment.outputs.assignment_dir }}" >> grade_report.md
        echo "**æäº¤æ—¶é—´**: $(date)" >> grade_report.md
        echo "" >> grade_report.md
        
        if [ "$SCORE" -ge 90 ]; then
          echo "## ğŸ‰ ä¼˜ç§€ (${SCORE}/100)" >> grade_report.md
          echo "æ­å–œï¼æ‚¨çš„ä½œä¸šå®Œæˆå¾—éå¸¸å¥½ï¼" >> grade_report.md
        elif [ "$SCORE" -ge 80 ]; then
          echo "## ğŸ‘ è‰¯å¥½ (${SCORE}/100)" >> grade_report.md
          echo "åšå¾—ä¸é”™ï¼è¿˜æœ‰å°çš„æ”¹è¿›ç©ºé—´ã€‚" >> grade_report.md
        elif [ "$SCORE" -ge 60 ]; then
          echo "## ğŸ“ åŠæ ¼ (${SCORE}/100)" >> grade_report.md
          echo "åŸºæœ¬å®Œæˆè¦æ±‚ï¼Œä½†éœ€è¦æ”¹è¿›ã€‚" >> grade_report.md
        else
          echo "## âŒ éœ€è¦æ”¹è¿› (${SCORE}/100)" >> grade_report.md
          echo "ä½œä¸šæœªè¾¾åˆ°åŸºæœ¬è¦æ±‚ï¼Œè¯·ä»”ç»†æ£€æŸ¥ä»£ç ã€‚" >> grade_report.md
        fi
        
        echo "" >> grade_report.md
        echo "## ğŸ“‹ è¯¦ç»†æµ‹è¯•ç»“æœ" >> grade_report.md
        echo "\`\`\`" >> grade_report.md
        cat "${{ steps.detect-assignment.outputs.assignment_dir }}/test_results.txt" >> grade_report.md
        echo "\`\`\`" >> grade_report.md
        
        cat grade_report.md
    
    - name: è¯„è®ºPR
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('grade_report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });
    
    - name: è®¾ç½®PRçŠ¶æ€
      uses: actions/github-script@v7
      with:
        script: |
          const score = parseInt('${{ steps.run-tests.outputs.score }}') || 0;
          const state = score >= 60 ? 'success' : 'failure';
          const description = `å¾—åˆ†: ${score}/100`;
          
          github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: context.payload.pull_request.head.sha,
            state: state,
            target_url: `${context.payload.pull_request.html_url}#issuecomment`,
            description: description,
            context: 'auto-grader'
          });